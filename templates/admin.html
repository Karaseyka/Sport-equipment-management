{% extends "base.html" %}
{% block content %}
<div class="container">
    <div class="inventory-list">
        <h2 align="center">Управление инвентарем</h2>
        <table align="center">
            <tr>

                <td><h3 align="center">Название</h3></td>
                <td><h3 align="center">Количество</h3></td>
                <td><h3 align="center">Состояние</h3></td>

            </tr>
            <tr>
                <form method="POST">
                    <td><input type="text" name="name_item"/></td>
                    <td><input type="number" name="quantity"/></td>
                    <td><select id="condition" name="condition">
                        <option value="good">В отличном состоянии</option>
                        <option value="bad">Неисправен</option>
                        <option value="out">Не в наличии</option>
                    </select></td>
                    <td>
                        <button type="submit">Подтвердить</button>
                    </td>
                </form>
            </tr>
        </table>
    </div>
    <h3>Ваш инвентарь</h3>
    <div class="row">
        <div class="col-sm-6">
            {% for item in inventory %}
            {% if inventory.index(item) % 2 == 0 %}
            <div class="col-md-14">
                <div class="inventory-item">
                    <h5 id="itemName{{ item.id }}">{{ item.name }}</h5>
                    <input type="text" id="editItemName{{ item.id }}" class="form-control d-none"
                           value="{{ item.name }}"/>

                    <p>Количество предметов: <span id="itemCount{{ item.id }}">{{ item.count }}</span></p>
                    <input type="number" id="editItemCount{{ item.id }}" class="form-control d-none"
                           value="{{ item.count }}"/>

                    <p>Состояние: <span id="itemState{{ item.id }}">
                    {% if item.state == "good" %} В отличном состоянии {% elif item.state == "bad" %} Неисправен {% else %} Не в наличии {% endif %}
                     </span></p>
                    <select id="editItemState{{ item.id }}" class="form-select d-none">
                        <option value="good" {% if item.state==
                        "good" %} selected {% endif %}>В отличном состоянии</option>
                        <option value="bad" {% if item.state==
                        "bad" %} selected {% endif %}>Неисправен</option>
                        <option value="out" {% if item.state==
                        "out" %} selected {% endif %}>Не в наличии</option>
                    </select>
                    <button class="btn btn-primary" onclick="toggleEditMode('{{ item.id }}', this)"
                            data-editing="false">Изменить
                    </button>
                    <button class="btn btn-danger" onclick="deleteItem('{{ item.id }}', this)"
                            data-editing="false">Удалить
                    </button>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        <div class="col-sm-6">
            {% for item in inventory %}
            {% if inventory.index(item) % 2 != 0 %}
            <div class="col-md-14">
                <div class="inventory-item">
                    <h5 id="itemName{{ item.id }}">{{ item.name }}</h5>
                    <input type="text" id="editItemName{{ item.id }}" class="form-control d-none"
                           value="{{ item.name }}"/>

                    <p>Количество предметов: <span id="itemCount{{ item.id }}">{{ item.count }}</span></p>
                    <input type="number" id="editItemCount{{ item.id }}" class="form-control d-none"
                           value="{{ item.count }}"/>

                    <p>Состояние: <span id="itemState{{ item.id }}">
                    {% if item.state == "good" %} В отличном состоянии {% elif item.state == "bad" %} Неисправен {% else %} Не в наличии {% endif %}
                    </span></p>
                    <select id="editItemState{{ item.id }}" class="form-select d-none">
                        <option value="good" {% if item.state==
                        "good" %} selected {% endif %}>В отличном состоянии</option>
                        <option value="bad" {% if item.state==
                        "bad" %} selected {% endif %}>Неисправен</option>
                        <option value="out" {% if item.state==
                        "out" %} selected {% endif %}>Не в наличии</option>
                    </select>

                    <button class="btn btn-primary" onclick="toggleEditMode('{{ item.id }}', this)"
                            data-editing="false">Изменить
                    </button>
                    <button class="btn btn-danger" onclick="deleteItem('{{ item.id }}', this)"
                            data-editing="false">Удалить
                    </button>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
</div>
</div>

<script>
    function deleteItem(itemId, button) {
       fetch(`/api/delete-item/${itemId}`, {
        method: 'DELETE', // Метод запроса
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Ошибка при удалении элемента');
        }
        return response.json(); // Если нужно, обрабатываем ответ
    })
    .then(data => {
        console.log('Элемент успешно удален:', data);
        const itemElement = button.closest('.inventory-item');
        if (itemElement) {
            itemElement.remove();
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
    });
}
    function toggleEditMode(id, button) {
        const isEditing = button.dataset.editing === "true";

        if (isEditing) {
            saveChanges(id);
            button.textContent = "Изменить";
            button.classList.remove("btn-success");
            button.classList.add("btn-primary");
            button.dataset.editing = "false";
        } else {
            enableEditMode(id);
            button.textContent = "Сохранить";
            button.classList.remove("btn-primary");
            button.classList.add("btn-success");
            button.dataset.editing = "true";
        }
    }

    function enableEditMode(id) {
        document.getElementById(`itemName${id}`).classList.add('d-none');
        document.getElementById(`itemCount${id}`).classList.add('d-none');
        document.getElementById(`itemState${id}`).classList.add('d-none');

        document.getElementById(`editItemName${id}`).classList.remove('d-none');
        document.getElementById(`editItemCount${id}`).classList.remove('d-none');
        document.getElementById(`editItemState${id}`).classList.remove('d-none');
    }

    function saveChanges(id) {
        const newName = document.getElementById(`editItemName${id}`).value;
        const newCount = document.getElementById(`editItemCount${id}`).value;
        const newState = document.getElementById(`editItemState${id}`).value;

        // Обновление данных на клиенте
        document.getElementById(`itemName${id}`).textContent = newName;
        document.getElementById(`itemCount${id}`).textContent = newCount;
        document.getElementById(`itemState${id}`).textContent =
            newState === "good" ? "В отличном состоянии" :
            newState === "bad" ? "Неисправен" : "Не в наличии";

        document.getElementById(`itemName${id}`).classList.remove('d-none');
        document.getElementById(`itemCount${id}`).classList.remove('d-none');
        document.getElementById(`itemState${id}`).classList.remove('d-none');

        document.getElementById(`editItemName${id}`).classList.add('d-none');
        document.getElementById(`editItemCount${id}`).classList.add('d-none');
        document.getElementById(`editItemState${id}`).classList.add('d-none');

        fetch('/update-item/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                id: id,
                name: newName,
                count: newCount,
                state: newState
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Ошибка при сохранении данных на сервере.');
            }
            console.log(response);
        })
        .then(data => {
            console.log('Данные успешно обновлены:', data);
        })
        .catch(error => {
            console.error('Произошла ошибка:', error);
            alert('Не удалось сохранить изменения на сервере. Попробуйте еще раз.');
        });
    }

    function getCSRFToken() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        return csrfToken ? csrfToken.value : '';
    }




</script>


{% endblock %}
